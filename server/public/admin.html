<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel Push (Render)</title>
  <style>
    body{font-family:system-ui,Arial;margin:0;background:#0b0b0b;color:#fff;padding:22px}
    .card{max-width:860px;margin:0 auto;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:16px}
    input,textarea{width:100%;padding:12px;border-radius:10px;border:0;margin:8px 0 12px}
    button{padding:12px 14px;border:0;border-radius:10px;font-weight:900;cursor:pointer}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .muted{opacity:.85;font-size:13px;line-height:1.4}
    code{background:rgba(0,0,0,.35);padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
  <div class="card">
    <h2 style="margin:0 0 6px;">Painel de Notificações ✅</h2>
    <div class="muted">Este painel envia Push para os PWAs registrados.</div>

    <p class="muted">Inscritos: <b id="subs">0</b></p>

    <label>Título</label>
    <input id="title" placeholder="Cartomantes Online" value="Cartomantes Online" />

    <label>Mensagem</label>
    <textarea id="body" rows="3" placeholder="Escreva a mensagem..."></textarea>

    <label>URL ao clicar (recomendado)</label>
    <input id="url" value="https://marcio2307.github.io/cartomantesonline.site/leituras.html?pwa=true" />

    <label>Ícone (opcional)</label>
    <input id="icon" value="https://marcio2307.github.io/cartomantesonline.site/logo.png" />

    <div class="row">
      <button id="send">Enviar para todos</button>
      <button id="refresh">Atualizar inscritos</button>
    </div>

    <p id="status" class="muted" style="margin-top:12px;"></p>

    <hr style="border:0;border-top:1px solid rgba(255,255,255,.12);margin:14px 0">

    <div class="muted">
      Testes:
      <div>• <code>/health</code></div>
      <div>• <code>/api/subscribers</code></div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const setStatus = (m) => $("status").textContent = m;

    async function refreshSubs(){
      const r = await fetch("/api/subscribers");
      const j = await r.json();
      $("subs").textContent = j.total ?? 0;
    }

    $("refresh").onclick = () => refreshSubs().catch(e => setStatus("Erro: " + (e?.message || e)));

    $("send").onclick = async () => {
      try{
        const msg = $("body").value.trim();
        if(!msg){
          setStatus("❌ Digite uma mensagem antes de enviar.");
          return;
        }

        setStatus("Enviando...");

        const res = await fetch("/api/send", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({
            title: $("title").value,
            body: msg,
            url: $("url").value,
            icon: $("icon").value
          })
        });

        const j = await res.json().catch(async () => ({ error: await res.text().catch(()=> "") }));

        if(!res.ok){
          setStatus("❌ Erro no servidor: " + res.status + " " + (j.error || ""));
          return;
        }

        setStatus("✅ Enviado. success=" + j.success + " failed=" + j.failed + " total=" + j.total);
        await refreshSubs();
      }catch(e){
        setStatus("❌ " + (e?.message || e));
      }
    };

    refreshSubs().catch(()=>{});
  </script>
</body>
</html>
